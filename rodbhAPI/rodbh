--====== Make local table to keep variables from main program ======--
local variables = {}

--======= Replace table variables with reference of given table ======--
function initTable(t)
	assert(type(t) == "table", "Invalid argument in function 'initTable', expected table")
	variables = t
end

--======= Function converting string to boolean used for importing data from file ======--
function toBool(var)
	if var then
		return true
	elseif not var then
		return false
	else
		return nil
	end
end

--=========== Function responsible for printing messages and sending them over RedNet ======--
function sendAndPrint(message)
	assert(type(message) == "string", "Invalid argument in function 'sendAndPrint', expected string")
	print(message)
	if variables.recId ~= nil then
		rednet.send(variables.recId, message)
	end
end

--=========== Functions responsible for moving turtle with location memory =======--
function moveForward(noCheck)
	noCheck = noCheck or false
	if not noCheck then checkAll() end
	if not turtle.forward() then
		if not turtle.detect() then
			if turtle.attack() then
				turtle.suck()
			else
				goToStart()
				variables.excavateFinish = true
				sendAndPrint(variables.bedrockMsg)
				return false
			end
		elseif not turtle.dig() then
			goToStart()
			variables.excavateFinish = true
			sendAndPrint(variables.bedrockMsg)
			return false
		end
		sleep(0)
		moveForward(true)
	else
		if variables.direction == 1 then variables.z = variables.z + 1
		elseif variables.direction == 2 then variables.x = variables.x - 1
		elseif variables.direction == 3 then variables.z = variables.z - 1
		elseif variables.direction == 4 then variables.x = variables.x + 1
		end
		local rodbhTmp = io.open("/rodbh.tmp", "w")
		rodbhTmp:write(textutils.serialize(variables))
		rodbhTmp:close()
	end
	return true
end

function moveUp(noCheck)
	noCheck = noCheck or false
	if not noCheck then checkAll() end
	if not turtle.up() then
		if not turtle.detectUp() then
			if turtle.attackUp() then
				turtle.suckUp()
			else
				goToStart()
				variables.excavateFinish = true
				sendAndPrint(variables.bedrockMsg)
				return false
			end
		elseif not turtle.digUp() then
			goToStart()
			variables.excavateFinish = true
			sendAndPrint(variables.bedrockMsg)
			return false
		end
		sleep(0)
		moveUp(true)
	else
		variables.y = variables.y + 1
		local rodbhTmp = io.open("/rodbh.tmp", "w")
		rodbhTmp:write(textutils.serialize(variables))
		rodbhTmp:close()
	end
	return true
end

function moveDown(noCheck)
	noCheck = noCheck or false
	if not noCheck then checkAll() end
	if not turtle.down() then
		if not turtle.detectDown() then
			if turtle.attackDown() then
				turtle.suckDown()
			else
				sendAndPrint(variables.bedrockMsg)
				return false
			end
		elseif not turtle.digDown() then
			sendAndPrint(variables.bedrockMsg)
			return false
		end
		sleep(0)
		moveDown(true)
	else
		variables.y = variables.y - 1
		local rodbhTmp = io.open("/rodbh.tmp", "w")
		rodbhTmp:write(textutils.serialize(variables))
		rodbhTmp:close()
	end
	return true
end

function leftTurn()
	turtle.turnLeft()
	variables.direction = variables.direction + 1
	if variables.direction == 5 then variables.direction = 1 end
end

function rightTurn()
	turtle.turnRight()
	variables.direction = variables.direction - 1
	if variables.direction == 0 then variables.direction = 4 end
end

function turnAround()
	rightTurn()
	rightTurn()
end

function faceNorth()
	if variables.direction == 1 then
		return true
	elseif variables.direction == 2 then
		rightTurn()
		return true
	elseif variables.direction == 3 then
		turnAround()
		return true
	elseif variables.direction == 4 then
		leftTurn()
		return true
	end
end

function faceWest()
	if variables.direction == 1 then
		leftTurn()
		return true
	elseif variables.direction == 2 then
		return true
	elseif variables.direction == 3 then
		rightTurn()
		return true
	elseif variables.direction == 4 then
		turnAround()
		return true
	end
end
	
function faceSouth()
	if variables.direction == 1 then
		turnAround()
		return true
	elseif variables.direction == 2 then
		leftTurn()
		return true
	elseif variables.direction == 3 then
		return true
	elseif variables.direction == 4 then
		rightTurn()
		return true
	end
end

function faceEast()
	if variables.direction == 1 then
		rightTurn()
		return true
	elseif variables.direction == 2 then
		turnAround()
		return true
	elseif variables.direction == 3 then
		leftTurn()
		return true
	elseif variables.direction == 4 then
		return true
	end
end

function goToStart()
	variables.xTmp, variables.yTmp, variables.zTmp = variables.x, variables.y, variables.z
	variables.directionTmp = variables.direction
	
	if variables.y < 0 then
		while math.abs(variables.y) ~= 0 do moveUp(true) end
	else
		while math.abs(variables.y) ~= 0 do moveDown(true) end
	end
	
	if variables.x == 0 then
		faceSouth()
	elseif variables.x < 0 then
		faceEast()
	else
		faceWest()
	end
	while math.abs(variables.x) ~= 0 do moveForward(true) end
	
	faceSouth()
	while math.abs(variables.z) ~= 0 do moveForward(true) end
	
end

function goToEnd()
	faceNorth()
	while math.abs(variables.z) < math.abs(variables.zTmp) do moveForward() end
	if variables.xTmp < 0 then
		faceWest()
	else
		faceEast()
	end
	while math.abs(variables.x) < math.abs(variables.xTmp) do moveForward() end
	
	if variables.yTmp < 0 then	
		while math.abs(variables.y) < math.abs(variables.yTmp) do moveDown() end
	else
		while math.abs(variables.y) < math.abs(variables.yTmp) do moveUp() end
	end
	
	if variables.directionTmp == 1 then faceNorth()
		elseif variables.directionTmp == 2 then faceWest()
		elseif variables.directionTmp == 3 then faceSouth()
		elseif variables.directionTmp == 4 then faceEast()
	end
end

--====== Make turtle to face the right way for digging ========--
function horizontalFaceFront(front)
	if variables.horizontalBool == front then 
		faceEast()
	else
		faceWest()
	end
end

--=========== Checking if there's enough fuel, fill and room in the inventory ===========--

function checkInv()
	local emptySlots = 0
	for i = 2, 15, 1 do
		if turtle.getItemCount(i) == 0 then
			emptySlots = emptySlots + 1
		end
	end
	if emptySlots <= 1 then
		return false
	else
		return true
	end
end

function checkFuel(start)
	assert(type(start) == "boolean" or type(start) == "nil", "Function checkFuel requires boolean or nil as argument.")
	start = start or false
	if start then
		if turtle.getFuelLevel() < (math.abs(variables.xTmp) 
								  + math.abs(variables.yTmp) 
								  + math.abs(variables.zTmp) + 2) * 2 then
			return false
		else
			return true
		end
	else
		if turtle.getFuelLevel() < math.abs(variables.x) 
								 + math.abs(variables.y) 
								 + math.abs(variables.z) + 2 then
			return false
		else
			return true
		end
	end
end

function getFuel(start)
		assert(type(start) == "boolean" or type(start) == "nil", "Function getFuel requires boolean or nil as argument.")
		turtle.select(16)
		turtle.refuel()
		return checkFuel(start or false)
end

function checkFill()
	if variables.mode ~= "nofill" then
		if turtle.getItemCount(1) <= 2 then
			return false
		else
			return true
		end
	else
		return true
	end
end

function getFillChest()
	for i = 1, 8, 1 do
		if turtle.getItemSpace(i) ~= 0 then
			turtle.select(i)
			turtle.suck()
		end
	end
	return checkFill()
end

function getFill()
	local i = 1
	while turtle.getItemSpace(1) ~= 0 and i <= 16 do
		turtle.select(i)
		turtle.transferTo(1)
		i = i + 1
	end
	return checkFill()
end

function dumpInv()
	if variables.mode == "all" then
		for i = 1, 16, 1 do
			if turtle.getItemCount(i) ~= 0 then
				turtle.select(i)
				if not turtle.drop() then return false end
			end
		end
	elseif variables.mode == "nofill" then
		for i = 1, 15, 1 do
			if turtle.getItemCount(i) ~= 0 then
				turtle.select(i)
			if not turtle.drop() then return false end
			end
		end
	elseif variables.mode == "fill" then
		for i = 2, 15, 1 do
			if turtle.getItemCount(i) ~= 0 then
				turtle.select(i)
				if not turtle.compareTo(1) then
				if not turtle.drop() then return false end
				end
			end
		end
	end
	return true
end

function getAll()
	goToStart()
	faceSouth()
	
	if not dumpInv() then
		sendAndPrint(variables.invMsg)
		while not dumpInv() do sleep(1) end
		sendAndPrint(variables.continueMsg)
	end
	
	if not getFuel(true) then
		sendAndPrint(variables.fuelMsg)
		while not checkFuel(true) do
			turtle.select(16)
			turtle.refuel()
			sleep(1)
		end
		sendAndPrint(variables.continueMsg)
	end
	
	if variables.roomType ~= "nofill" and variables.roomType ~= "excavate" then
		faceWest()
		moveForward(true)
		faceSouth()
		if not getFillChest() then
			if not getFill() then
				sendAndPrint(variables.fillMsg)
				while not checkFill() do
					getFillChest()
					getFill()
					sleep(1)
				end
				sendAndPrint(variables.continueMsg)
			end
		end
		faceEast()
		moveForward(true)
	end
	turtle.select(1)
	goToEnd()
end

function checkAll()
	if not checkInv() then getAll()
	elseif not checkFuel() then
		if not getFuel() then getAll() end
	elseif not checkFill() then
		if not getFill() then getAll() end
	end	
end

function place()
	checkAll()
	if not turtle.compare(1) then
		if not turtle.detect() then
			turtle.select(1)
			if not turtle.place() then
				if not turtle.attack() then
					return false
				else
					turtle.suck()
					sleep(0)
					place()
				end
			else
				return true
			end
		else
			if not turtle.dig() then
				return false
			else
				sleep(0)
				place()
			end
		end
	end
	return true
end

function placeUp()
	checkAll()
	if not turtle.compareUp(1) then
		if not turtle.detectUp() then
			turtle.select(1)
			if not turtle.placeUp() then
				if not turtle.attackUp() then
					return false
				else
					turtle.suckUp()
					sleep(0)
					placeUp()
				end
			else
				return true
			end
		else
			if not turtle.digUp() then
				return false
			else
				sleep(0)
				placeUp()
			end
		end
	end
	return true
end

function placeDown()
	checkAll()
	if not turtle.compareDown(1) then
		if not turtle.detectDown() then
			turtle.select(1)
			if not turtle.placeDown() then
				if not turtle.attackDown() then
					return false
				else
					turtle.suckDown()
					sleep(0)
					placeDown()
				end
			else
				return true
			end
		else
			if not turtle.digDown() then
				return false
			else
				sleep(0)
				placeDown()
			end
		end
	end
	return true
end

function nextStep()
	faceNorth()
	moveForward()
	variables.verticalBool = not variables.verticalBool
	variables.horizontalBool = not variables.horizontalBool
end

function nextLayer(placeBool)
	placeBool = placeBool or false
	if not variables.verticalBool then
		moveDown()
	else
		moveUp()
	end
	if placeBool then
		place()
	end
	variables.horizontalBool = not variables.horizontalBool
end
